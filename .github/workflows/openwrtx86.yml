name: OpenWrt ImageBuilder x86_64 HP T620 (USB Ready)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # ------------------------------------------------------
    - name: Checkout
      uses: actions/checkout@v4

    # ------------------------------------------------------
    # Download OpenWrt ImageBuilder
    # ------------------------------------------------------
    - name: Download ImageBuilder
      run: |
        wget https://downloads.openwrt.org/releases/24.10.0/targets/x86/64/openwrt-imagebuilder-24.10.0-x86-64.Linux-x86_64.tar.zst
        tar -I zstd -xf openwrt-imagebuilder-24.10.0-x86-64.Linux-x86_64.tar.zst
        mv openwrt-imagebuilder-* imagebuilder

    # ------------------------------------------------------
    # Auto-resize rootfs script
    # ------------------------------------------------------
    - name: Add auto-resize script
      run: |
        mkdir -p imagebuilder/files/etc/init.d/
        cat << "EOF" > imagebuilder/files/etc/init.d/resize-rootfs
        #!/bin/sh /etc/rc.common
        START=99
        USE_PROCD=1
        start_service() {
            ROOTDEV="$(mount | grep 'on / ' | awk '{print $1}')"
            [ -f /etc/.rootfs_resized ] && exit 0
            command -v growpart >/dev/null 2>&1 && growpart ${ROOTDEV%[0-9]} ${ROOTDEV##*[^0-9]}
            resize2fs "$ROOTDEV"
            touch /etc/.rootfs_resized
        }
        EOF
        chmod +x imagebuilder/files/etc/init.d/resize-rootfs

    # ------------------------------------------------------
    # Custom Files (Network config â€“ Change IP)
    # ------------------------------------------------------
    - name: Modify default LAN IP to 192.168.1.2
      run: |
        mkdir -p imagebuilder/files/etc/config
        cat << "EOF" > imagebuilder/files/etc/config/network
        config interface 'loopback'
                option ifname 'lo'
                option proto 'static'
                option ipaddr '127.0.0.1'
                option netmask '255.0.0.0'
        
        config interface 'lan'
                option device 'eth0'
                option proto 'static'
                option ipaddr '192.168.1.2'
                option netmask '255.255.255.0'
                option gateway '192.168.1.1'
                option dns '8.8.8.8'
        EOF

    # ------------------------------------------------------
    # Build with ImageBuilder
    # ------------------------------------------------------
    - name: Build OpenWrt image
      run: |
        cd imagebuilder
        make image PROFILE="generic" \
          PACKAGES="\
            luci luci-base luci-ssl \
            dnsmasq-full \
            luci-app-openclash \
            luci-app-passwall \
            luci-app-statistics collectd collectd-mod-interface collectd-mod-iwinfo collectd-mod-cpu collectd-mod-memory \
            luci-theme-alpha \
            kmod-usb-net-rndis kmod-usb-net kmod-usb2 kmod-usb3 \
            kmod-tun ipset ip-full \
            kmod-rtl8xxxu kmod-rtl8192cu kmod-rt2800-usb kmod-ath9k-htc \
          " \
          FILES="files"

    # ------------------------------------------------------
    # Create 4GB USB Ready Image
    # ------------------------------------------------------
    - name: Create USB-ready image (4GB)
      run: |
        cd imagebuilder/bin/targets/x86/64
        qemu-img create -f raw openwrt-t620-usb.img 4G
        sudo losetup -fP openwrt-t620-usb.img
        LOOPDEV=$(losetup -j openwrt-t620-usb.img | cut -d: -f1)

        sudo parted $LOOPDEV mklabel msdos
        sudo parted -a optimal $LOOPDEV mkpart primary ext4 1MiB 100%
        sudo mkfs.ext4 ${LOOPDEV}p1

        mkdir -p mnt
        sudo mount ${LOOPDEV}p1 mnt
        sudo tar -xpf openwrt-x86-64-generic-squashfs-rootfs.tar.gz -C mnt
        sudo umount mnt
        sudo losetup -d $LOOPDEV

    # ------------------------------------------------------
    # Upload Artifact
    # ------------------------------------------------------
    - name: Upload USB Image
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-x86-64-t620-usb
        path: imagebuilder/bin/targets/x86/64/openwrt-t620-usb.img