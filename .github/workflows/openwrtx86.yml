name: OpenWrt x86_64 Auto Build + USB-ready + IPK (.img <2GB, .img.gz)

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *" # Jalankan otomatis setiap hari jam 03:00 UTC

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # Maks waktu build 4 jam

    env:
      GH_PAT: ${{ secrets.GH_PAT }}  # Token GitHub untuk push release

    steps:
    # ================================================================
    # 1. Checkout repository
    # ================================================================
    - name: Checkout repository
      uses: actions/checkout@v4

    # ================================================================
    # 2. Ambil versi OpenWrt terbaru
    # ================================================================
    - name: Get latest OpenWrt version
      id: get_version
      run: |
        LATEST=$(curl -s https://downloads.openwrt.org/releases/ | grep -Po '([0-9]{2}\.[0-9]{2}\.[0-9]{1,2})/' | sort -V | tail -1 | tr -d '/')
        echo "LATEST=$LATEST" >> $GITHUB_ENV
        echo "Latest OpenWrt version: $LATEST"

    # ================================================================
    # 3. Cek apakah versi terbaru sudah dibuild
    # ================================================================
    - name: Check if already built
      id: check_build
      uses: actions/github-script@v6
      with:
        script: |
          const latest = process.env.LATEST;
          const releases = await github.rest.repos.listReleases({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 20
          });
          const alreadyBuilt = releases.data.some(r => r.tag_name.includes(latest));
          core.setOutput("result", alreadyBuilt);
      env:
        LATEST: ${{ env.LATEST }}

    # ================================================================
    # 4. Install dependencies
    # ================================================================
    - name: Install dependencies
      if: steps.check_build.outputs.result != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y wget zstd xz-utils squashfs-tools \
          qemu-utils dosfstools e2fsprogs parted rsync unzip file \
          build-essential gawk python3 curl git cloud-guest-utils \
          util-linux syslinux syslinux-utils mtools extlinux grub-pc-bin

    # ================================================================
    # 5. Download ImageBuilder
    # ================================================================
    - name: Download ImageBuilder
      if: steps.check_build.outputs.result != 'true'
      run: |
        set -e
        URL="https://downloads.openwrt.org/releases/${LATEST}/targets/x86/64/openwrt-imagebuilder-${LATEST}-x86-64.Linux-x86_64.tar.zst"
        echo "Downloading ImageBuilder: $URL"
        wget -q --show-progress "$URL" -O imagebuilder.tar.zst
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst
        mv openwrt-imagebuilder-* imagebuilder

    # ================================================================
    # 6. Tambahkan file custom untuk konfigurasi & IPK
    # ================================================================
    - name: Add custom files
      if: steps.check_build.outputs.result != 'true'
      run: |
        mkdir -p imagebuilder/files/etc/config imagebuilder/files/etc/init.d imagebuilder/files/etc/uci-defaults imagebuilder/files/tmp/ipk
        # network config
        cat > imagebuilder/files/etc/config/network <<'EOF'
        config interface 'loopback'
            option device 'lo'
            option proto 'static'
            option ipaddr '127.0.0.1'
            option netmask '255.0.0.0'
        config interface 'lan'
            option device 'eth0'
            option proto 'static'
            option ipaddr '192.168.1.2'
            option netmask '255.255.255.0'
        config interface 'usb0'
            option proto 'dhcp'
        EOF

        # resize rootfs first boot
        cat > imagebuilder/files/etc/init.d/resize-rootfs <<'EOF'
        #!/bin/sh /etc/rc.common
        START=99
        start() {
            [ -f /etc/.rootfs_resized ] && exit 0
            ROOTDEV=$(mount | grep " on / " | awk '{print $1}')
            PARTBASE=$(echo $ROOTDEV | sed 's/[0-9]*$//')
            PARTNUM=$(echo $ROOTDEV | grep -o '[0-9]*$')
            if command -v growpart >/dev/null 2>&1; then
                growpart $PARTBASE $PARTNUM || true
            fi
            resize2fs $ROOTDEV || true
            touch /etc/.rootfs_resized
        }
        EOF
        chmod +x imagebuilder/files/etc/init.d/resize-rootfs

        # auto install IPK first boot
        cat > imagebuilder/files/etc/uci-defaults/99-install-ipk <<'EOF'
        #!/bin/sh
        IPK_DIR="/tmp/ipk"
        if [ -d "$IPK_DIR" ]; then
          for f in "$IPK_DIR"/*.ipk; do
            [ -f "$f" ] && opkg install "$f"
          done
        fi
        EOF
        chmod +x imagebuilder/files/etc/uci-defaults/99-install-ipk

    # ================================================================
    # 7. Download IPK eksternal
    # ================================================================
    - name: Download IPK files
      if: steps.check_build.outputs.result != 'true'
      run: |
        wget -O imagebuilder/files/tmp/ipk/luci-theme-alpha4.ipk \
          https://github.com/derisamedia/luci-theme-alpha/releases/download/alpha-4.0.1-beta/luci-theme-alpha4_4.0.1-beta-12_all.ipk || true
        wget -O imagebuilder/files/tmp/ipk/luci-app-openclash.ipk \
          https://github.com/vernesong/OpenClash/releases/download/v0.47.028/luci-app-openclash_0.47.028_all.ipk || true

    # ================================================================
    # 8. Build firmware OpenWrt
    # ================================================================
    - name: Build firmware
      if: steps.check_build.outputs.result != 'true'
      run: |
        cd imagebuilder
        PACKAGES=(luci luci-base bash curl ca-bundle ipset ip-full ruby ruby-yaml unzip \
          iptables kmod-ipt-nat iptables-mod-extra iptables-mod-tproxy \
          kmod-usb-net kmod-usb-net-rndis kmod-usb-net-cdc-ether \
          kmod-usb-net-cdc-ncm kmod-usb-net-ipheth \
          parted fdisk lsblk e2fsprogs resize2fs)
        PKG_STR=$(printf "%s " "${PACKAGES[@]}")
        echo "Building firmware with packages: $PKG_STR"
        make image PROFILE="generic" FILES="files" PACKAGES="$PKG_STR"

    # ================================================================
    # 9. Buat USB image bootable BIOS + minimal UEFI
    # ================================================================
    - name: Create USB image
      if: steps.check_build.outputs.result != 'true'
      run: |
        set -euo pipefail
        cd imagebuilder/bin/targets/x86/64 || exit 1
        ROOTFS_TAR=$(ls *-rootfs.tar.gz 2>/dev/null | head -n1 || true)
        KERNEL=$(ls *vmlinuz *-vmlinuz 2>/dev/null | head -n1 || true)
        IMG_NAME="openwrt-x86-64-usb.img"
        IMG_FINAL="${IMG_NAME}.gz"
        IMG_SIZE=1500M

        fallocate -l $IMG_SIZE "$IMG_NAME"
        LOOP=$(sudo losetup -f --show "$IMG_NAME")

        sudo parted -s $LOOP mklabel gpt
        sudo parted -s $LOOP mkpart primary fat32 1MiB 100MiB
        sudo parted -s $LOOP set 1 boot on
        sudo parted -s $LOOP mkpart primary ext4 150MiB 100%
        sudo partprobe $LOOP
        sudo losetup -d $LOOP
        LOOP=$(sudo losetup -f --show -P "$IMG_NAME")
        ESP="${LOOP}p1"
        ROOT="${LOOP}p2"

        sudo mkfs.vfat -F32 -n BOOT "$ESP"
        sudo mkfs.ext4 -F "$ROOT"

        mkdir -p /tmp/esp /tmp/root
        sudo mount "$ESP" /tmp/esp
        sudo mount "$ROOT" /tmp/root

        sudo tar -xzf "$ROOTFS_TAR" -C /tmp/root
        [ -n "$KERNEL" ] && [ -f "$KERNEL" ] && sudo cp "$KERNEL" /tmp/root/boot/vmlinuz

        # BIOS boot via extlinux
        sudo mkdir -p /tmp/root/boot/extlinux
        sudo extlinux --install /tmp/root/boot/extlinux
        sudo tee /tmp/root/boot/extlinux/extlinux.conf > /dev/null <<'EOF'
        DEFAULT openwrt
        TIMEOUT 50
        LABEL openwrt
            KERNEL /boot/vmlinuz
            APPEND root=/dev/sda2 rw
        EOF

        # UEFI boot minimal
        sudo mkdir -p /tmp/esp/EFI/BOOT
        [ -f "$KERNEL" ] && sudo cp "$KERNEL" /tmp/esp/EFI/BOOT/BOOTX64.EFI

        sync
        sudo umount /tmp/esp /tmp/root
        rmdir /tmp/esp /tmp/root
        sudo losetup -d "$LOOP"

        gzip -c "$IMG_NAME" > "$IMG_FINAL"
        mkdir -p $GITHUB_WORKSPACE/build_artifacts
        mv "$IMG_NAME" "$IMG_FINAL" $GITHUB_WORKSPACE/build_artifacts/

    # ================================================================
    # 10. Generate release tag
    # ================================================================
    - name: Generate release tag
      if: steps.check_build.outputs.result != 'true'
      run: echo "RELEASE_TAG=v${{ env.LATEST }}-$(date +'%Y%m%d-%H%M')" >> $GITHUB_ENV

    # ================================================================
    # 11. Create and push Git tag
    # ================================================================
    - name: Create and push Git tag
      if: steps.check_build.outputs.result != 'true'
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git tag ${{ env.RELEASE_TAG }}
        git push origin ${{ env.RELEASE_TAG }}

    # ================================================================
    # 12. Create GitHub Release & upload firmware
    # ================================================================
    - name: Create GitHub Release and upload firmware
      if: steps.check_build.outputs.result != 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: "OpenWrt x86_64 USB-ready ext4 ${{ env.LATEST }} Build #${{ github.run_number }}"
        files: |
          build_artifacts/openwrt-x86-64-usb.img.gz
          imagebuilder/bin/targets/x86/64/*-rootfs.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}