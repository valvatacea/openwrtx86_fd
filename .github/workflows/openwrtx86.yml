name: OpenWrt x86_64 ImageBuilder + Passwall - USB Ready (Automated)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    # 1. Checkout repo
    - name: Checkout
      uses: actions/checkout@v4

    # 2. Install dependencies
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget zstd tar xz-utils squashfs-tools \
          qemu-utils dosfstools e2fsprogs parted rsync unzip file \
          build-essential gawk python3 curl jq

    # 3. Detect latest OpenWrt x86_64 release
    - name: Detect latest OpenWrt release
      id: detect_release
      run: |
        LATEST=$(curl -s https://downloads.openwrt.org/releases/ | grep -Po 'href="\K[0-9.]+(?=/")' | sort -V | tail -1)
        echo "LATEST_RELEASE=$LATEST" >> $GITHUB_ENV
        echo "Latest OpenWrt release detected: $LATEST"

    # 4. Download ImageBuilder
    - name: Download ImageBuilder x86_64
      run: |
        URL="https://downloads.openwrt.org/releases/${LATEST_RELEASE}/targets/x86/64/openwrt-imagebuilder-${LATEST_RELEASE}-x86-64.Linux-x86_64.tar.zst"
        wget -q --show-progress "$URL" -O imagebuilder.tar.zst
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst
        mv openwrt-imagebuilder-* imagebuilder

    # 5. Add custom files (network + autoresize)
    - name: Add custom files
      run: |
        mkdir -p imagebuilder/files/etc/config
        mkdir -p imagebuilder/files/etc/init.d

        cat > imagebuilder/files/etc/config/network <<'EOF'
        config interface 'loopback'
                option device 'lo'
                option proto 'static'
                option ipaddr '127.0.0.1'
                option netmask '255.0.0.0'
        
        config interface 'lan'
                option device 'eth0'
                option proto 'static'
                option ipaddr '192.168.1.2'
                option netmask '255.255.255.0'
        EOF

        cat > imagebuilder/files/etc/init.d/resize-rootfs <<'EOF'
        #!/bin/sh /etc/rc.common
        START=99
        start() {
          ROOTDEV="$(mount | grep ' on / ' | awk '{print $1}')"
          [ -f /etc/.rootfs_resized ] && exit 0
          if command -v growpart >/dev/null 2>&1; then
            growpart ${ROOTDEV%[0-9]} ${ROOTDEV##*[^0-9]} || true
          fi
          resize2fs "$ROOTDEV" || true
          touch /etc/.rootfs_resized
        }
        EOF
        chmod +x imagebuilder/files/etc/init.d/resize-rootfs

    # 6. Add Passwall feed dynamically
    - name: Add Passwall feed
      run: |
        FEED_BASE="https://openwrt.proxy.19gs.cn/packages/x86_64"
        cat >> imagebuilder/repositories.conf <<EOF
        src/gz passwall_luci ${FEED_BASE}/passwall_luci
        src/gz passwall_core ${FEED_BASE}/passwall
        src/gz passwall_packages ${FEED_BASE}/packages
        EOF

    # 7. Build firmware (modular & safe)
    - name: Build firmware
      run: |
        cd imagebuilder

        PACKAGES=(
          luci luci-ssl luci-app-opkg luci-app-firewall luci-app-statistics luci-theme-alpha luci-proto-ppp
          dnsmasq-full ip-full
          kmod-usb-net kmod-usb-net-rndis kmod-usb-net-cdc-ether kmod-usb-net-cdc-ncm kmod-usb-net-ipheth
          kmod-rtl8xxxu kmod-rtl8192cu kmod-rtl8188eu kmod-mt7601u
          wget-ssl curl ca-bundle
          luci-app-passwall chinadns-ng v2ray-core xray-core sing-box v2ray-geoip v2ray-geosite hysteria
        )

        PKG_STR=$(printf "%s " "${PACKAGES[@]}")

        make image PROFILE="generic" FILES="files" PACKAGES="$PKG_STR"

    # 8. List artifacts
    - name: List artifacts
      run: |
        cd imagebuilder/bin/targets/x86/64
        ls -lah

    # 9. Create USB-ready image
    - name: Create USB image (~4GB)
      run: |
        cd imagebuilder/bin/targets/x86/64

        ROOTFS_TAR=$(ls *rootfs*.tar* 2>/dev/null | head -n1 || true)
        SQUASH_IMG=$(ls *squashfs*.img 2>/dev/null | head -n1 || true)

        if [ -n "$ROOTFS_TAR" ]; then
          ROOTFS_FILE="$ROOTFS_TAR"
        elif [ -n "$SQUASH_IMG" ]; then
          unsquashfs -d tmproot $SQUASH_IMG
          tar -C tmproot -cf openwrt-rootfs-from-squashfs.tar .
          ROOTFS_FILE="openwrt-rootfs-from-squashfs.tar"
        else
          echo "No rootfs archive or squashfs found!"
          exit 1
        fi

        IMGNAME="openwrt-x86-64-usb-4G.img"
        qemu-img create -f raw "$IMGNAME" 4G
        LOOP=$(sudo losetup --show -fP "$IMGNAME")
        sudo parted -s "$LOOP" mklabel msdos
        sudo parted -s "$LOOP" mkpart primary ext4 1MiB 100%
        sleep 1
        PART="${LOOP}p1"
        sudo mkfs.ext4 -F "$PART"
        mkdir -p mnt
        sudo mount "$PART" mnt

        if file "$ROOTFS_FILE" | grep -qi gzip; then
          sudo tar -xzf "$ROOTFS_FILE" -C mnt
        else
          sudo tar -xpf "$ROOTFS_FILE" -C mnt
        fi

        sudo chmod +x mnt/etc/init.d/* || true
        sudo umount mnt
        sudo losetup -d "$LOOP"

        echo "USB image created: $IMGNAME"
        ls -lh "$IMGNAME"

    # 10. Upload artifacts
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-imagebuilder-artifacts
        path: |
          imagebuilder/bin/targets/x86/64/*.img
          imagebuilder/bin/targets/x86/64/*.tar.gz
          imagebuilder/bin/targets/x86/64/openwrt-x86-64-usb-4G.img