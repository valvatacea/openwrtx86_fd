name: OpenWrt x86_64 ImageBuilder + Manual IPK + Full Packages - USB Ready

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    # --------------------------------------------------
    # 1. Checkout repository
    # --------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # --------------------------------------------------
    # 2. Install dependencies
    # --------------------------------------------------
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget zstd tar xz-utils squashfs-tools \
          qemu-utils dosfstools e2fsprogs parted rsync unzip file \
          build-essential gawk python3 curl

    # --------------------------------------------------
    # 3. Detect latest OpenWrt release
    # --------------------------------------------------
    - name: Detect latest OpenWrt release
      id: detect_release
      run: |
        LATEST=$(curl -s https://downloads.openwrt.org/releases/ | grep -Po 'href="\K[0-9.]+(?=/")' | sort -V | tail -1)
        echo "LATEST_RELEASE=$LATEST" >> $GITHUB_ENV

    # --------------------------------------------------
    # 4. Download ImageBuilder
    # --------------------------------------------------
    - name: Download ImageBuilder
      run: |
        URL="https://downloads.openwrt.org/releases/${LATEST_RELEASE}/targets/x86/64/openwrt-imagebuilder-${LATEST_RELEASE}-x86-64.Linux-x86_64.tar.zst"
        wget -q --show-progress "$URL" -O imagebuilder.tar.zst
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst
        mv openwrt-imagebuilder-* imagebuilder

    # --------------------------------------------------
    # 5. Download ipk files (manual URL)
    # --------------------------------------------------
    - name: Download ipk files (manual URL)
      run: |
        mkdir -p imagebuilder/files/tmp/ipk

        # luci-theme-alpha
        wget -O imagebuilder/files/tmp/ipk/luci-theme-alpha4_4.0.1-beta-12_all.ipk \
          https://github.com/derisamedia/luci-theme-alpha/releases/download/alpha-4.0.1-beta/luci-theme-alpha4_4.0.1-beta-12_all.ipk

        # OpenClash
        wget -O imagebuilder/files/tmp/ipk/luci-app-openclash_0.47.028_all.ipk \
          https://github.com/vernesong/OpenClash/releases/download/v0.47.028/luci-app-openclash_0.47.028_all.ipk

    # --------------------------------------------------
    # 6. Auto-install IPK on first boot
    # --------------------------------------------------
    - name: Auto-install IPK on first boot
      run: |
        mkdir -p imagebuilder/files/etc/uci-defaults
        cat > imagebuilder/files/etc/uci-defaults/99-install-ipk <<'EOF'
        #!/bin/sh
        IPK_DIR="/tmp/ipk"
        if [ -d "$IPK_DIR" ]; then
          for f in "$IPK_DIR"/*.ipk; do
            [ -f "$f" ] && opkg install "$f"
          done
        fi
        EOF
        chmod +x imagebuilder/files/etc/uci-defaults/99-install-ipk

    # --------------------------------------------------
    # 7. Add custom network + resize-rootfs
    # --------------------------------------------------
    - name: Add custom network + resize-rootfs
      run: |
        mkdir -p imagebuilder/files/etc/config
        mkdir -p imagebuilder/files/etc/init.d

        cat > imagebuilder/files/etc/config/network <<'EOF'
        config interface 'loopback'
                option device 'lo'
                option proto 'static'
                option ipaddr '127.0.0.1'
                option netmask '255.0.0.0'
        
        config interface 'lan'
                option device 'eth0'
                option proto 'static'
                option ipaddr '192.168.1.2'
                option netmask '255.255.255.0'
        EOF

        cat > imagebuilder/files/etc/init.d/resize-rootfs <<'EOF'
        #!/bin/sh /etc/rc.common
        START=99
        start() {
          ROOTDEV="$(mount | grep ' on / ' | awk '{print $1}')"
          [ -f /etc/.rootfs_resized ] && exit 0
          if command -v growpart >/dev/null 2>&1; then
            growpart ${ROOTDEV%[0-9]} ${ROOTDEV##*[^0-9]} || true
          fi
          resize2fs "$ROOTDEV" || true
          touch /etc/.rootfs_resized
        }
        EOF
        chmod +x imagebuilder/files/etc/init.d/resize-rootfs

    # --------------------------------------------------
    # 8. Build firmware
    # --------------------------------------------------
    - name: Build firmware
      run: |
        cd imagebuilder

        # Hapus dnsmasq bawaan agar tidak clash
        rm -f staging_dir/target-x86_64_musl/root-x86/usr/sbin/dnsmasq
        rm -f staging_dir/target-x86_64_musl/root-x86/etc/init.d/dnsmasq
        rm -f staging_dir/target-x86_64_musl/root-x86/etc/hotplug.d/ntp/25-dnsmasqsec

        PACKAGES=(
          luci luci-base dnsmasq-full bash curl ca-bundle ipset ip-full
          ruby ruby-yaml unzip
          iptables kmod-ipt-nat iptables-mod-tproxy iptables-mod-extra
          kmod-tun luci-compat ip6tables-mod-nat kmod-inet-diag kmod-nft-tproxy
        )
        PKG_STR=$(printf "%s " "${PACKAGES[@]}")
        make image PROFILE="generic" FILES="files" PACKAGES="$PKG_STR"

    # --------------------------------------------------
    # 9. Create USB image (~4GB)
    # --------------------------------------------------
    - name: Create USB image (~4GB)
      run: |
        cd imagebuilder/bin/targets/x86/64
        ROOTFS_TAR=$(ls *rootfs*.tar* 2>/dev/null | head -n1 || true)
        SQUASH_IMG=$(ls *squashfs*.img 2>/dev/null | head -n1 || true)

        if [ -n "$ROOTFS_TAR" ]; then
          ROOTFS_FILE="$ROOTFS_TAR"
        elif [ -n "$SQUASH_IMG" ]; then
          unsquashfs -d tmproot $SQUASH_IMG
          tar -C tmproot -cf openwrt-rootfs-from-squashfs.tar .
          ROOTFS_FILE="openwrt-rootfs-from-squashfs.tar"
        else
          echo "No rootfs archive or squashfs found!"
          exit 1
        fi

        IMGNAME="openwrt-x86-64-usb-4G.img"
        qemu-img create -f raw "$IMGNAME" 4G
        LOOP=$(sudo losetup --show -fP "$IMGNAME")
        sudo parted -s "$LOOP" mklabel msdos
        sudo parted -s "$LOOP" mkpart primary ext4 1MiB 100%
        sleep 1
        PART="${LOOP}p1"
        sudo mkfs.ext4 -F "$PART"
        mkdir -p mnt
        sudo mount "$PART" mnt

        if file "$ROOTFS_FILE" | grep -qi gzip; then
          sudo tar -xzf "$ROOTFS_FILE" -C mnt
        else
          sudo tar -xpf "$ROOTFS_FILE" -C mnt
        fi

        sudo chmod +x mnt/etc/init.d/* || true
        sudo umount mnt
        sudo losetup -d "$LOOP"

        echo "USB image created: $IMGNAME"
        ls -lh "$IMGNAME"

    # --------------------------------------------------
    # 10. Upload artifacts
    # --------------------------------------------------
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-imagebuilder-artifacts
        path: |
          imagebuilder/bin/targets/x86/64/*.img
          imagebuilder/bin/targets/x86/64/*.tar.gz
          imagebuilder/bin/targets/x86/64/openwrt-x86-64-usb-4G.img