name: OpenWrt USB-ready x86_64 HP T620 Full (USB 4GB)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential git subversion libncurses5-dev gawk \
          gettext libssl-dev xsltproc wget unzip zstd ccache \
          python3 python3-dev python3-setuptools python3-pip \
          parted e2fsprogs qemu-utils
          
     - name: Set up ccache
      run: |
        export CCACHE_DIR=$HOME/.ccache
        export CCACHE_MAXSIZE=5G
        ccache -M $CCACHE_MAXSIZE

    - name: Clone OpenWrt
      run: |
        git clone --depth 1 https://git.openwrt.org/openwrt/openwrt.git openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Remove Python packages causing warnings
      run: |
        cd openwrt
        rm -rf package/feeds/packages/fail2ban
        rm -rf package/feeds/packages/flent
        rm -rf package/feeds/packages/python-babel
        rm -rf package/feeds/packages/python-docker
        rm -rf package/feeds/packages/python-incremental

    - name: Add auto-resize rootfs
      run: |
        cd openwrt
        mkdir -p files/etc/init.d/
        cat << "EOF" > files/etc/init.d/resize-rootfs
        #!/bin/sh /etc/rc.common
        START=99
        USE_PROCD=1
        start_service() {
            ROOTDEV="$(mount | grep 'on / ' | awk '{print $1}')"
            [ -f /etc/.rootfs_resized ] && exit 0
            command -v growpart >/dev/null 2>&1 && growpart ${ROOTDEV%[0-9]} ${ROOTDEV##*[^0-9]}
            resize2fs "$ROOTDEV"
            touch /etc/.rootfs_resized
        }
        EOF
        chmod +x files/etc/init.d/resize-rootfs

    - name: Set LAN IP to 192.168.1.2
      run: |
        cd openwrt
        mkdir -p files/etc/config
        cat << "EOF" > files/etc/config/network
        config interface 'loopback'
            option ifname 'lo'
            option proto 'static'
            option ipaddr '127.0.0.1'
            option netmask '255.0.0.0'
        
        config interface 'lan'
            option type 'bridge'
            option ifname 'eth0'
            option proto 'static'
            option ipaddr '192.168.1.2'
            option netmask '255.255.255.0'
        EOF

    - name: Add feeds (Passwall & OpenClash)
      run: |
        cd openwrt
        echo "src-git passwall https://github.com/xiaorouji/openwrt-passwall-packages" >> feeds.conf.default
        echo "src-git passwall_luci https://github.com/xiaorouji/openwrt-passwall" >> feeds.conf.default
        echo "src-git openclash https://github.com/vernesong/OpenClash" >> feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure Build for HP T620 Full
      run: |
        cd openwrt
        make defconfig
        # Core packages
        echo "CONFIG_PACKAGE_kmod-usb-net-rndis=y" >> .config
        echo "CONFIG_PACKAGE_kmod-tun=y" >> .config
        echo "CONFIG_PACKAGE_ipset=y" >> .config
        echo "CONFIG_PACKAGE_ip-full=y" >> .config
        # WiFi USB modules
        echo "CONFIG_PACKAGE_kmod-rtl8xxxu=y" >> .config
        echo "CONFIG_PACKAGE_kmod-rtl8192cu=y" >> .config
        echo "CONFIG_PACKAGE_kmod-rtl8812au=y" >> .config
        echo "CONFIG_PACKAGE_kmod-rtl8814au=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ath9k-htc=y" >> .config
        echo "CONFIG_PACKAGE_kmod-rt2800-usb=y" >> .config
        # LuCI full
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-ssl=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-statistics=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-opkg=y" >> .config
        # DNSMasq full
        echo "CONFIG_PACKAGE_dnsmasq-full=y" >> .config
        # Passwall & OpenClash
        echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        # Tema Alpha
        echo "CONFIG_PACKAGE_luci-theme-alpha=y" >> .config
        make defconfig

    - name: Build firmware
      run: |
        cd openwrt
        make -j$(nproc) V=s

    - name: Create USB-ready image (~3.8GB)
      run: |
        cd openwrt/bin/targets/x86/64
        qemu-img create -f raw openwrt-x86-64-t620-usb.img 3.8G
        sudo losetup -fP openwrt-x86-64-t620-usb.img
        LOOPDEV=$(losetup -j openwrt-x86-64-t620-usb.img | cut -d: -f1)
        sudo parted $LOOPDEV mklabel msdos
        sudo parted -a optimal $LOOPDEV mkpart primary ext4 1MiB 100%
        sudo mkfs.ext4 ${LOOPDEV}p1
        mkdir -p mnt
        sudo mount ${LOOPDEV}p1 mnt
        sudo tar -xpf openwrt-x86-64-combined-squashfs.img -C mnt
        sudo umount mnt
        sudo losetup -d $LOOPDEV

    - name: Upload USB-ready image
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-x86-64-t620-usb-4gb-full
        path: openwrt/bin/targets/x86/64/openwrt-x86-64-t620-usb.img