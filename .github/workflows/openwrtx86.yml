name: OpenWrt x86_64 Auto Build + USB-ready + IPK (ext4 <2GB)

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *" # cek setiap hari jam 03:00 UTC

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    env:
      GH_PAT: ${{ secrets.GH_PAT }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # ----------------------------------------
    # 1. Ambil versi OpenWrt terbaru
    # ----------------------------------------
    - name: Get latest OpenWrt version
      id: get_version
      run: |
        LATEST=$(curl -s https://downloads.openwrt.org/releases/ | grep -Po '([0-9]{2}\.[0-9]{2}\.[0-9]{1,2})/' | sort -V | tail -1 | tr -d '/')
        echo "LATEST=$LATEST" >> $GITHUB_ENV

    # ----------------------------------------
    # 2. Cek apakah sudah ada release versi ini
    # ----------------------------------------
    - name: Check if already built
      id: check_build
      uses: actions/github-script@v6
      with:
        script: |
          const latest = process.env.LATEST;
          const releases = await github.rest.repos.listReleases({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 10
          });
          const alreadyBuilt = releases.data.some(r => r.tag_name.includes(latest));
          console.log(`Already built: ${alreadyBuilt}`);
          return alreadyBuilt;
      env:
        LATEST: ${{ env.LATEST }}

    # ----------------------------------------
    # 3. Install dependencies
    # ----------------------------------------
    - name: Install dependencies
      if: steps.check_build.outputs.result != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y wget zstd xz-utils squashfs-tools \
          qemu-utils dosfstools e2fsprogs parted rsync unzip file \
          build-essential gawk python3 curl git cloud-guest-utils \
          util-linux

    # ----------------------------------------
    # 4. Download ImageBuilder
    # ----------------------------------------
    - name: Download ImageBuilder
      if: steps.check_build.outputs.result != 'true'
      run: |
        URL="https://downloads.openwrt.org/releases/${LATEST}/targets/x86/64/openwrt-imagebuilder-${LATEST}-x86-64.Linux-x86_64.tar.zst"
        wget -q --show-progress "$URL" -O imagebuilder.tar.zst
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst
        mv openwrt-imagebuilder-* imagebuilder

    # ----------------------------------------
    # 5. Tambahkan custom files (network, resize-rootfs)
    # ----------------------------------------
    - name: Add custom files
      if: steps.check_build.outputs.result != 'true'
      run: |
        mkdir -p imagebuilder/files/etc/config
        mkdir -p imagebuilder/files/etc/init.d

        # Network default
        cat > imagebuilder/files/etc/config/network <<'EOF'
        config interface 'loopback'
                option device 'lo'
                option proto 'static'
                option ipaddr '127.0.0.1'
                option netmask '255.0.0.0'

        config interface 'lan'
                option device 'eth0'
                option proto 'static'
                option ipaddr '192.168.1.2'
                option netmask '255.255.255.0'

        config interface 'usb0'
                option proto 'dhcp'
        EOF

        # Resize rootfs otomatis
        cat > imagebuilder/files/etc/init.d/resize-rootfs <<'EOF'
        #!/bin/sh /etc/rc.common
        START=99

        start() {
            [ -f /etc/.rootfs_resized ] && exit 0

            ROOTDEV=$(mount | grep " on / " | awk '{print $1}')
            PARTBASE=$(echo $ROOTDEV | sed 's/[0-9]*$//')
            PARTNUM=$(echo $ROOTDEV | grep -o '[0-9]*$')

            if command -v growpart >/dev/null 2>&1; then
                growpart $PARTBASE $PARTNUM
            fi

            resize2fs $ROOTDEV
            touch /etc/.rootfs_resized
        }
        EOF
        chmod +x imagebuilder/files/etc/init.d/resize-rootfs

    # ----------------------------------------
    # 6. Download IPK external
    # ----------------------------------------
    - name: Download IPK files
      if: steps.check_build.outputs.result != 'true'
      run: |
        mkdir -p imagebuilder/files/tmp/ipk
        wget -O imagebuilder/files/tmp/ipk/luci-theme-alpha4.ipk \
          https://github.com/derisamedia/luci-theme-alpha/releases/download/alpha-4.0.1-beta/luci-theme-alpha4_4.0.1-beta-12_all.ipk
        wget -O imagebuilder/files/tmp/ipk/luci-app-openclash.ipk \
          https://github.com/vernesong/OpenClash/releases/download/v0.47.028/luci-app-openclash_0.47.028_all.ipk

    # ----------------------------------------
    # 7. Setup IPK auto-install
    # ----------------------------------------
    - name: Setup IPK auto-install
      if: steps.check_build.outputs.result != 'true'
      run: |
        mkdir -p imagebuilder/files/etc/uci-defaults
        cat > imagebuilder/files/etc/uci-defaults/99-install-ipk <<'EOF'
        #!/bin/sh
        IPK_DIR="/tmp/ipk"
        if [ -d "$IPK_DIR" ]; then
          for f in "$IPK_DIR"/*.ipk; do
            [ -f "$f" ] && opkg install "$f"
          done
        fi
        EOF
        chmod +x imagebuilder/files/etc/uci-defaults/99-install-ipk

    # ----------------------------------------
    # 8. Build firmware (squashfs + rootfs tar.gz)
    # ----------------------------------------
    - name: Build firmware
      if: steps.check_build.outputs.result != 'true'
      run: |
        cd imagebuilder
        PACKAGES=(
          luci luci-base bash curl ca-bundle ipset ip-full ruby ruby-yaml unzip
          iptables kmod-ipt-nat iptables-mod-extra iptables-mod-tproxy
          kmod-usb-net kmod-usb-net-rndis kmod-usb-net-cdc-ether
          kmod-usb-net-cdc-ncm kmod-usb-net-ipheth
          parted fdisk lsblk e2fsprogs resize2fs
        )
        PKG_STR=$(printf "%s " "${PACKAGES[@]}")
        make image PROFILE="generic" FILES="files" PACKAGES="$PKG_STR"

    # ----------------------------------------
    # 9. Create USB image ext4 < 2GB
    # ----------------------------------------
    - name: Create USB image (bootable)
      if: steps.check_build.outputs.result != 'true'
      run: |
        cd imagebuilder/bin/targets/x86/64 || exit 1

        ROOTFS_TAR=$(ls *-rootfs.tar.gz 2>/dev/null | head -n1 || true)
        IMG_NAME="openwrt-x86-64-usb.ext4"

        if [ -z "$ROOTFS_TAR" ]; then
          echo "ERROR: Rootfs tar.gz not found."
          exit 1
        fi

        echo "Membuat ext4 bootable image dari $ROOTFS_TAR ..."
        
        # Buat image kosong 1.9GB
        fallocate -l 1.9G "$IMG_NAME"
        
        # Format sebagai ext4
        mkfs.ext4 "$IMG_NAME"
        
        # Mount sementara
        mkdir -p mnt
        sudo mount -o loop "$IMG_NAME" mnt
        
        # Extract rootfs ke image
        sudo tar -xzf "$ROOTFS_TAR" -C mnt
        
        # Unmount
        sudo umount mnt
        rmdir mnt

        echo "Bootable ext4 image siap: $IMG_NAME"
        echo "Ukuran: $(du -h "$IMG_NAME")"

    # ----------------------------------------
    # 10. Generate release tag
    # ----------------------------------------
    - name: Generate release tag
      if: steps.check_build.outputs.result != 'true'
      run: echo "RELEASE_TAG=v${{ env.LATEST }}-$(date +'%Y%m%d-%H%M')" >> $GITHUB_ENV

    # ----------------------------------------
    # 11. Push Git Tag
    # ----------------------------------------
    - name: Create and push Git tag
      if: steps.check_build.outputs.result != 'true'
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git tag ${{ env.RELEASE_TAG }}
        git push origin ${{ env.RELEASE_TAG }}

    # ----------------------------------------
    # 12. Release
    # ----------------------------------------
    - name: Create GitHub Release and upload firmware
      if: steps.check_build.outputs.result != 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: "OpenWrt x86_64 USB-ready ext4 ${{ env.LATEST }} Build #${{ github.run_number }}"
        files: |
          imagebuilder/bin/targets/x86/64/openwrt-x86-64-usb.ext4
          imagebuilder/bin/targets/x86/64/*-rootfs.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}