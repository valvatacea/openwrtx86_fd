name: OpenWrt x86_64 Auto Build + USB-ready Image

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"  # cek setiap hari jam 03:00 UTC

jobs:
  check_and_build:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # -----------------------------
    # 1. Cek versi OpenWrt terbaru
    # -----------------------------
    - name: Get latest OpenWrt version
      id: get_version
      run: |
        LATEST=$(curl -s https://downloads.openwrt.org/releases/ | grep -Po '([0-9]{2}\.[0-9]{2}\.[0-9]{1,2})/' | sort -V | tail -1 | tr -d '/')
        echo "Latest OpenWrt version: $LATEST"
        echo "LATEST=$LATEST" >> $GITHUB_ENV

    # -----------------------------
    # 2. Check if already built
    # -----------------------------
    - name: Check if already built
      id: already_built
      uses: actions/github-script@v6
      with:
        script: |
          const latest = process.env.LATEST;
          const releases = await github.rest.repos.listReleases({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 1
          });
          if (releases.data.length > 0) {
            const last_tag = releases.data[0].tag_name.replace(/^v/, '');
            if (last_tag.includes(latest)) {
              console.log(`Latest OpenWrt ${latest} already built. Exiting...`);
              return true;
            }
          }
          return false
      env:
        LATEST: ${{ env.LATEST }}

    - name: Stop if already built
      if: steps.already_built.outputs.result == 'true'
      run: |
        echo "No new OpenWrt release. Workflow will exit."
        exit 0

    # -----------------------------
    # 3. Install dependencies
    # -----------------------------
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget zstd tar xz-utils squashfs-tools \
          qemu-utils dosfstools e2fsprogs parted rsync unzip file \
          build-essential gawk python3 curl

    # -----------------------------
    # 4. Download ImageBuilder
    # -----------------------------
    - name: Download ImageBuilder
      run: |
        URL="https://downloads.openwrt.org/releases/${LATEST}/targets/x86/64/openwrt-imagebuilder-${LATEST}-x86-64.Linux-x86_64.tar.zst"
        wget -q --show-progress "$URL" -O imagebuilder.tar.zst
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst
        mv openwrt-imagebuilder-* imagebuilder

    # -----------------------------
    # 5. Add custom network + resize-rootfs
    # -----------------------------
    - name: Add custom network + resize-rootfs
      run: |
        mkdir -p imagebuilder/files/etc/config
        mkdir -p imagebuilder/files/etc/init.d

        cat > imagebuilder/files/etc/config/network <<'EOF'
        config interface 'loopback'
                option device 'lo'
                option proto 'static'
                option ipaddr '127.0.0.1'
                option netmask '255.0.0.0'
        
        config interface 'lan'
                option device 'eth0'
                option proto 'static'
                option ipaddr '192.168.1.2'
                option netmask '255.255.255.0'
        EOF

        cat > imagebuilder/files/etc/init.d/resize-rootfs <<'EOF'
        #!/bin/sh /etc/rc.common
        START=99
        start() {
          ROOTDEV="$(mount | grep ' on / ' | awk '{print $1}')"
          [ -f /etc/.rootfs_resized ] && exit 0
          if command -v growpart >/dev/null 2>&1; then
            growpart ${ROOTDEV%[0-9]} ${ROOTDEV##*[^0-9]} || true
          fi
          resize2fs "$ROOTDEV" || true
          touch /etc/.rootfs_resized
        }
        EOF
        chmod +x imagebuilder/files/etc/init.d/resize-rootfs

    # -----------------------------
    # 6. Download IPK files (manual)
    # -----------------------------
    - name: Download IPK files
      run: |
        mkdir -p imagebuilder/files/tmp/ipk
        wget -O imagebuilder/files/tmp/ipk/luci-theme-alpha4_4.0.1-beta-12_all.ipk \
          https://github.com/derisamedia/luci-theme-alpha/releases/download/alpha-4.0.1-beta/luci-theme-alpha4_4.0.1-beta-12_all.ipk
        wget -O imagebuilder/files/tmp/ipk/luci-app-openclash_0.47.028_all.ipk \
          https://github.com/vernesong/OpenClash/releases/download/v0.47.028/luci-app-openclash_0.47.028_all.ipk

    # -----------------------------
    # 7. Setup IPK auto-install
    # -----------------------------
    - name: Setup IPK auto-install
      run: |
        mkdir -p imagebuilder/files/etc/uci-defaults
        cat > imagebuilder/files/etc/uci-defaults/99-install-ipk <<'EOF'
        #!/bin/sh
        IPK_DIR="/tmp/ipk"
        if [ -d "$IPK_DIR" ]; then
          for f in "$IPK_DIR"/*.ipk; do
            [ -f "$f" ] && opkg install "$f"
          done
        fi
        EOF
        chmod +x imagebuilder/files/etc/uci-defaults/99-install-ipk

    # -----------------------------
    # 8. Build firmware
    # -----------------------------
    - name: Build firmware
      run: |
        cd imagebuilder
        PACKAGES=(
          luci luci-base bash curl ca-bundle ipset ip-full
          ruby ruby-yaml unzip
          iptables kmod-ipt-nat iptables-mod-tproxy iptables-mod-extra
          kmod-tun luci-compat ip6tables-mod-nat kmod-inet-diag kmod-nft-tproxy
        )
        PKG_STR=$(printf "%s " "${PACKAGES[@]}")
        make image PROFILE="generic" FILES="files" PACKAGES="$PKG_STR"

    # -----------------------------
    # 9. Create USB-ready image auto-size
    # -----------------------------
    - name: Create USB image (auto-size)
      run: |
        cd imagebuilder/bin/targets/x86/64
        ROOTFS_TAR=$(ls *rootfs*.tar* 2>/dev/null | head -n1 || true)
        SQUASH_IMG=$(ls *squashfs*.img 2>/dev/null | head -n1 || true)

        if [ -n "$ROOTFS_TAR" ]; then
          ROOTFS_FILE="$ROOTFS_TAR"
        elif [ -n "$SQUASH_IMG" ]; then
          unsquashfs -d tmproot "$SQUASH_IMG"
          tar -C tmproot -cf openwrt-rootfs-from-squashfs.tar .
          ROOTFS_FILE="openwrt-rootfs-from-squashfs.tar"
        else
          echo "No rootfs found!"
          exit 1
        fi

        # Hitung ukuran rootfs + buffer 30%
        ROOTFS_SIZE=$(du -b "$ROOTFS_FILE" | awk '{print $1}')
        IMG_SIZE=$((ROOTFS_SIZE + ROOTFS_SIZE/3))

        IMGNAME="openwrt-x86-64-usb-auto.img"
        qemu-img create -f raw "$IMGNAME" "$IMG_SIZE"

        LOOP=$(sudo losetup --show -fP "$IMGNAME")
        sudo parted -s "$LOOP" mklabel msdos
        sudo parted -s "$LOOP" mkpart primary ext4 1MiB 100%
        sleep 1
        PART="${LOOP}p1"
        sudo mkfs.ext4 -F "$PART"

        mkdir -p mnt
        sudo mount "$PART" mnt
        if file "$ROOTFS_FILE" | grep -qi gzip; then
          sudo tar -xzf "$ROOTFS_FILE" -C mnt
        else
          sudo tar -xpf "$ROOTFS_FILE" -C mnt
        fi
        sudo chmod +x mnt/etc/init.d/* || true
        sudo umount mnt
        sudo losetup -d "$LOOP"

        echo "USB-ready image created: $IMGNAME ($(du -h $IMGNAME))"

    # -----------------------------
    # 10. Create GitHub Release
    # -----------------------------
    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v${{ env.LATEST }}-$(date +'%Y%m%d-%H%M')"
        name: "OpenWrt x86_64 USB-ready ${{ env.LATEST }} Build #${{ github.run_number }}"
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # -----------------------------
    # 11. Upload firmware to release
    # -----------------------------
    - name: Upload firmware to release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          imagebuilder/bin/targets/x86/64/*.img
          imagebuilder/bin/targets/x86/64/*.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}