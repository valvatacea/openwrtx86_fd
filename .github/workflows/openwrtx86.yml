name: OpenWrt x86_64 ImageBuilder + Auto IPK (luci-theme-alpha + OpenClash) - USB Ready

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget zstd tar xz-utils squashfs-tools \
          qemu-utils dosfstools e2fsprogs parted rsync unzip file \
          build-essential gawk python3 curl jq

    # --------------------------------------------------
    # 1. Detect latest OpenWrt release
    # --------------------------------------------------
    - name: Detect latest OpenWrt release
      id: detect_release
      run: |
        LATEST=$(curl -s https://downloads.openwrt.org/releases/ | grep -Po 'href="\K[0-9.]+(?=/")' | sort -V | tail -1)
        echo "LATEST_RELEASE=$LATEST" >> $GITHUB_ENV

    # --------------------------------------------------
    # 2. Download ImageBuilder
    # --------------------------------------------------
    - name: Download ImageBuilder
      run: |
        URL="https://downloads.openwrt.org/releases/${LATEST_RELEASE}/targets/x86/64/openwrt-imagebuilder-${LATEST_RELEASE}-x86-64.Linux-x86_64.tar.zst"
        wget -q --show-progress "$URL" -O imagebuilder.tar.zst
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst
        mv openwrt-imagebuilder-* imagebuilder

    # --------------------------------------------------
    # 3. Download latest luci-theme-alpha IPK
    # --------------------------------------------------
    - name: Download latest luci-theme-alpha IPK
      run: |
        mkdir -p imagebuilder/files/tmp/ipk
        ALPHA_URL=$(curl -s https://api.github.com/repos/username/luci-theme-alpha/releases/latest \
          | jq -r '.assets[] | select(.name|test("x86_64.*\\.ipk")) | .browser_download_url')
        echo "Downloading luci-theme-alpha: $ALPHA_URL"
        wget -O imagebuilder/files/tmp/ipk/luci-theme-alpha.ipk "$ALPHA_URL"

    # --------------------------------------------------
    # 4. Download latest OpenClash IPK
    # --------------------------------------------------
    - name: Download latest OpenClash IPK
      run: |
        CLASH_URL=$(curl -s https://api.github.com/repos/vernesong/OpenClash/releases/latest \
          | jq -r '.assets[] | select(.name|test("x86_64.*\\.ipk")) | .browser_download_url')
        echo "Downloading OpenClash: $CLASH_URL"
        wget -O imagebuilder/files/tmp/ipk/luci-app-openclash.ipk "$CLASH_URL"

    # --------------------------------------------------
    # 5. Auto-install IPK on first boot
    # --------------------------------------------------
    - name: Auto-install IPK on first boot
      run: |
        mkdir -p imagebuilder/files/etc/uci-defaults
        cat > imagebuilder/files/etc/uci-defaults/99-install-ipk <<'EOF'
        #!/bin/sh
        IPK_DIR="/tmp/ipk"
        if [ -d "$IPK_DIR" ]; then
          for f in "$IPK_DIR"/*.ipk; do
            [ -f "$f" ] && opkg install "$f"
          done
        fi
        EOF
        chmod +x imagebuilder/files/etc/uci-defaults/99-install-ipk

    # --------------------------------------------------
    # 6. Add custom network + resize-rootfs
    # --------------------------------------------------
    - name: Add custom network + resize-rootfs
      run: |
        mkdir -p imagebuilder/files/etc/config
        mkdir -p imagebuilder/files/etc/init.d

        cat > imagebuilder/files/etc/config/network <<'EOF'
        config interface 'loopback'
                option device 'lo'
                option proto 'static'
                option ipaddr '127.0.0.1'
                option netmask '255.0.0.0'
        
        config interface 'lan'
                option device 'eth0'
                option proto 'static'
                option ipaddr '192.168.1.2'
                option netmask '255.255.255.0'
        EOF

        cat > imagebuilder/files/etc/init.d/resize-rootfs <<'EOF'
        #!/bin/sh /etc/rc.common
        START=99
        start() {
          ROOTDEV="$(mount | grep ' on / ' | awk '{print $1}')"
          [ -f /etc/.rootfs_resized ] && exit 0
          if command -v growpart >/dev/null 2>&1; then
            growpart ${ROOTDEV%[0-9]} ${ROOTDEV##*[^0-9]} || true
          fi
          resize2fs "$ROOTDEV" || true
          touch /etc/.rootfs_resized
        }
        EOF
        chmod +x imagebuilder/files/etc/init.d/resize-rootfs

    # --------------------------------------------------
    # 7. Build firmware
    # --------------------------------------------------
    - name: Build firmware
      run: |
        cd imagebuilder
        PACKAGES=(
          luci luci-ssl luci-app-opkg luci-app-firewall luci-app-statistics
          dnsmasq-full ip-full
          kmod-usb-net kmod-usb-net-rndis kmod-usb-net-cdc-ether \
          kmod-usb-net-cdc-ncm kmod-usb-net-ipheth
          kmod-rtl8xxxu kmod-rtl8192cu kmod-mt7601u
          wget-ssl curl ca-bundle
        )
        PKG_STR=$(printf "%s " "${PACKAGES[@]}")
        make image PROFILE="generic" FILES="files" PACKAGES="$PKG_STR"

    # --------------------------------------------------
    # 8. Create USB image (~4GB)
    # --------------------------------------------------
    - name: Create USB image (~4GB)
      run: |
        cd imagebuilder/bin/targets/x86/64
        ROOTFS_TAR=$(ls *rootfs*.tar* 2>/dev/null | head -n1 || true)
        SQUASH_IMG=$(ls *squashfs*.img 2>/dev/null | head -n1 || true)

        if [ -n "$ROOTFS_TAR" ]; then
          ROOTFS_FILE="$ROOTFS_TAR"
        elif [ -n "$SQUASH_IMG" ]; then
          unsquashfs -d tmproot $SQUASH_IMG
          tar -C tmproot -cf openwrt-rootfs-from-squashfs.tar .
          ROOTFS_FILE="openwrt-rootfs-from-squashfs.tar"
        else
          echo "No rootfs archive or squashfs found!"
          exit 1
        fi

        IMGNAME="openwrt-x86-64-usb-4G.img"
        qemu-img create -f raw "$IMGNAME" 4G
        LOOP=$(sudo losetup --show -fP "$IMGNAME")
        sudo parted -s "$LOOP" mklabel msdos
        sudo parted -s "$LOOP" mkpart primary ext4 1MiB 100%
        sleep 1
        PART="${LOOP}p1"
        sudo mkfs.ext4 -F "$PART"
        mkdir -p mnt
        sudo mount "$PART" mnt

        if file "$ROOTFS_FILE" | grep -qi gzip; then
          sudo tar -xzf "$ROOTFS_FILE" -C mnt
        else
          sudo tar -xpf "$ROOTFS_FILE" -C mnt
        fi

        sudo chmod +x mnt/etc/init.d/* || true
        sudo umount mnt
        sudo losetup -d "$LOOP"

        echo "USB image created: $IMGNAME"
        ls -lh "$IMGNAME"

    # --------------------------------------------------
    # 9. Upload artifacts
    # --------------------------------------------------
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-imagebuilder-artifacts
        path: |
          imagebuilder/bin/targets/x86/64/*.img
          imagebuilder/bin/targets/x86/64/*.tar.gz
          imagebuilder/bin/targets/x86/64/openwrt-x86-64-usb-4G.img