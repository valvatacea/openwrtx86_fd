name: Build OpenWrt USB Full 8GB

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
          g++-multilib gettext git libncurses-dev libssl-dev python3 unzip zlib1g-dev file rsync

    - name: Clone OpenWrt source
      run: |
        git clone --depth=1 https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Copy .config
      run: |
        if [ -f .config ]; then cp .config openwrt/.config; else echo ".config not found"; exit 1; fi

    - name: Build (defconfig + full build)
      run: |
        cd openwrt
        make defconfig
        make -j$(nproc) || make -j1 V=s

    - name: Upload firmware
      uses: actions/upload-artifact@v3
      with:
        name: openwrt-usb-8gb
        path: openwrt/bin/targets/x86/64/
